<% provide(:title, 'Mobile') %>
<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>



<div id="mobile-gmap_container">
	<div id="mobile-map-feed-form-over-map" class="hidden">
    <%= render partial: 'shared/business_feed_item', collection: @businesses %>
  </div>
	<div id="mobile-map" style='width: 100%; height: 100%;'></div>
</div>
<div id="trigger"><span>Show</span></div>



<% content_for :scripts do %>
<script type="text/javascript">
var handler2 = Gmaps.build('Google');
handler2.buildMap({ provider: { 
	zoom: 1,
	panBy: (500, 50),
	panControl: true,
	panControlOptions: {
		position: google.maps.ControlPosition.TOP_RIGHT
	},
	zoomControl: true,
	zoomControlOptions: {
        style: google.maps.ZoomControlStyle.LARGE,
        position: google.maps.ControlPosition.RIGHT_CENTER
    }
}, internal: {id: 'mobile-map'}}, function(){
  // I assume this is the way you retrieve the amrkers array
  var json_data = <%=raw @hash.to_json %>;
  var markers = handler2.addMarkers(json_data);

  _.each(json_data, function(json_marker, index){
      json_marker.marker = markers[index];
      google.maps.event.addListener(json_marker.marker.getServiceObject(), 'click', function( event ){
        var latlong = document.getElementById("latlong");
        latlong.innerHTML =( "Latitude: "+event.latLng.lat()+" "+", longitude: "+event.latLng.lng() );
            $.ajax({
        	url: '/map',
        	type: 'GET',
        	async: false,
        	data: { 
        		title: json_marker.title,
        		id: json_marker.id
        	}
        });

      });
  });
      handler2.bounds.extendWith(markers);
      handler2.fitMapToBounds();

      
});
//when the trigger is clicked we check to see if the popout is currently hidden
//based on the hidden we choose the correct animation
$('#trigger').click( function() {
    if ($('#mobile-map-feed-form-over-map').hasClass('hidden')) {
        $('#mobile-map-feed-form-over-map').removeClass('hidden');
        showPopout();
    }
    else {
        $('#mobile-map-feed-form-over-map').addClass('hidden');
        hidePopout();
    }
});

function showPopout() {
    $('#mobile-map-feed-form-over-map').animate({
        left: 300
    }, 'fast', function () {
        $('#trigger span').html('Close');  //change the trigger text at end of animation
    });
}

function hidePopout() {
    $('#mobile-map-feed-form-over-map').animate({
        left: -40
    }, 'fast', function () {
        $('#trigger span').html('Show');  //change the trigger text at end of animation
    });
}
</script>
<% end %>




